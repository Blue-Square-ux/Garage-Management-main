<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Service Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; }
    .sidebar { min-height: 100vh; background-color: #343a40; color: white; }
    .content { padding: 20px; }
    .nav-link { color: rgba(255,255,255,.8); }
    .nav-link:hover { color: white; }
    .active { background-color: rgba(255,255,255,.1); }
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-in-progress { background-color: #cce5ff; color: #004085; }
    .table-responsive {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .dashboard-header {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 px-0 sidebar">
        <div class="d-flex flex-column p-3">
          <h4 class="text-center mb-4">Service Dashboard</h4>
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <a href="/admin/dashboard" class="nav-link active">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a href="/admin/analytics" class="nav-link">
                <i class="bi bi-graph-up me-2"></i> Analytics
              </a>
            </li>
            <li class="nav-item mt-auto">
              <a href="/logout" class="nav-link text-danger">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 content">
        <div class="dashboard-header d-flex justify-content-between align-items-center">
          <div>
            <h4>Current Services</h4>
            <div id="currentTime" class="text-muted small"></div>
          </div>
          <div>
            <span class="me-3">
              <span class="status-badge status-pending">Pending: <%= pendingServices %></span>
            </span>
            <span class="me-3">
              <span class="status-badge status-in-progress">In Progress: <%= inProgressServices %></span>
            </span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Vehicle No.</th>
                <th>Work Type</th>
                <th>Bay</th>
                <th>Technician</th>
                <th>Helper</th>
                <th>Get-In Time</th>
                <th>Est. Time</th>
                <th>Status</th>
                <th>Remarks</th>
              </tr>
            </thead>
            <tbody>
              <% if (services && services.length > 0) {
                   let count = 1;
                   services.filter(service => service.status !== 'completed').forEach(service => {
                     // Override status based on T1 and T2 logic
                     if (service.T2) {
                       service.status = 'in-progress';
                     } else if (!service.T1 && !service.T2) {
                       service.status = 'pending';
                     }
              %>
              <tr>
                <td><%= count++ %></td>
                <td><strong><%= service.vehicleNumber %></strong></td>
                <td><%= service.typeOfWork %></td>
                <td><%= service.bayNumber || 'N/A' %></td>
                <td><%= service.assignedTechnician || 'Not assigned' %></td>
                <td><%= service.assignedHelper || 'N/A' %></td>
                <td>
                  <% if (service.getInTime) { %>
                    <%= new Date(service.getInTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <% if (service.estimatedCompletionTime) { %>
                    <%= new Date(service.estimatedCompletionTime).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' }) %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
                <td>
                  <% if (service.status === 'pending') { %>
                    <span class="status-badge status-pending">Pending</span>
                  <% } else if (service.status === 'in-progress') { %>
                    <span class="status-badge status-in-progress">In Progress</span>
                  <% } else { %>
                    <%= service.status %>
                  <% } %>
                </td>
                <td class="text-truncate" style="max-width: 150px;" title="<%= service.remarks || 'No remarks' %>">
                  <%= service.remarks || '-' %>
                </td>
              </tr>
              <% }) } else { %>
              <tr>
                <td colspan="10" class="text-center py-4 text-muted">
                  <i class="bi bi-inbox fs-1"></i>
                  <p class="mt-2">No services found</p>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Live Time Script + Auto-Refresh -->
  <script>
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('en-IN', { hour12: false });
      const dateString = now.toLocaleDateString('en-IN');
      document.getElementById('currentTime').textContent = `${dateString} ${timeString}`;
    }

    setInterval(updateTime, 1000);
    updateTime();

    // Auto-refresh every 5 minutes
    setTimeout(() => {
      window.location.reload();
    }, 300000);
  </script>
</body>
</html>